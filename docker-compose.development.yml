name: "store"

services:
  opensearch-node1:
    image: opensearchproject/opensearch:3
    container_name: opensearch-node1
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch-node1
      - discovery.seed_hosts=opensearch-node1,opensearch-node2
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2
      - bootstrap.memory_lock=true  # along with the memlock settings below, disables swapping
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m  # minimum and maximum Java heap size, recommend setting both to 50% of system RAM
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=P@ss2408word. # Sets the demo admin user password when using demo configuration, required for OpenSearch 2.12 and higher
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536  # maximum number of open files for the OpenSearch user, set to at least 65536 on modern systems
        hard: 65536
    volumes:
      - opensearch-data1:/usr/share/opensearch/data
    ports:
      - 9200:9200
      - 9600:9600  # required for Performance Analyzer
    networks:
      - opensearch-net

  opensearch-node2:
    image: opensearchproject/opensearch:3
    container_name: opensearch-node2
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch-node2
      - discovery.seed_hosts=opensearch-node1,opensearch-node2
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2
      - bootstrap.memory_lock=true
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=P@ss2408word.
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-data2:/usr/share/opensearch/data
    networks:
      - opensearch-net

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:3
    container_name: opensearch-dashboards
    ports:
      - 5601:5601
    expose:
      - '5601'
    environment:
      OPENSEARCH_HOSTS: '["https://opensearch-node1:9200","https://opensearch-node2:9200"]'
    networks:
      - opensearch-net

  sso:
    image: quay.io/keycloak/keycloak:26.3.4
    container_name: sso
    ports:
      - "8080:8080"
    command: start-dev
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: 123456
      KC_DB_SCHEMA: sso
      KC_DB_URL_DATABASE: store
      KC_DB_URL_HOST: database
      KC_DB_URL_PORT: 5432
    depends_on:
      - database
    networks:
      - database-sso-bridge
    restart: unless-stopped
  
  database:
    image: postgres:14.8-alpine3.18
    container_name: database
    volumes:
      - database_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - database-api-bridge
      - database-sso-bridge
    environment:
      POSTGRES_DB: "postgres"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "123456"
  
  seq:
    image: datalust/seq:2024.3
    container_name: seq
    ports:
      - "8020:80"
      - "5341:5341"
    volumes:
      - seq_data:/var/lib/seq/data
    environment:
      - ACCEPT_EULA=Y
  
  minio:
    image: 'bitnami/minio:2024.11.7'
    container_name: minio
    ports:
      - '9000:9000'
      - '9001:9001'
    networks:
      - minio-api-bridge
    volumes:
      - minio_data:/var/lib/minio/data
    environment:
      - MINIO_ROOT_USER=minio-root-user
      - MINIO_ROOT_PASSWORD=minio-root-password
  
  api:
    image: store
    container_name: store
    build:
      context: .
      dockerfile: Web/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"

      Postgres__Host: "database"
      Postgres__Port: "5432"
      Postgres__Username: "postgres"
      Postgres__Password: "123456"
      Postgres__SearchPath: "store"
      Postgres__Database: "store"

      Minio__AccessKey: "store"
      Minio__SecretKey: "TYIkGFpnFTReu9wZzOtJ3Bh6JFiDRqSKfqyxSvkM"
      Minio__Endpoint: "minio:9000"
      Minio__Ssl: "false"

      Serilog__Using__0: "Serilog.Sinks.Console"
      Serilog__Using__1: "Serilog.Sinks.File"
      Serilog__Using__2: "Serilog.Sinks.Seq"
      Serilog__Using__3: "Serilog.Exceptions"
      Serilog__Using__4: "Serilog.Enrichers.Environment"
      Serilog__MinimumLevel: "Warning"
      Serilog__WriteTo__0__Name: "Console"
      Serilog__WriteTo__0__Args__theme: "Serilog.Sinks.SystemConsole.Themes.AnsiConsoleTheme::Code, Serilog.Sinks.Console"
      Serilog__WriteTo__1__Name: "File"
      Serilog__WriteTo__1__Args__path: "Logs/log-.txt"
      Serilog__WriteTo__1__Args__rollingInterval: "Hour"
      Serilog__WriteTo__2__Name: "Seq"
      Serilog__WriteTo__2__Args__serverUrl: "http://localhost:5341"
      Serilog__Enrich__0: "WithExceptionDetails"
      Serilog__Enrich__1: "FromLogContext"
      Serilog__Enrich__2: "WithEnvironmentName"
      Serilog__Enrich__3: "WithEnvironmentUserName"
      Serilog__Enrich__4: "WithMachineName"
      Serilog__Enrich__5: "WithAssemblyName"
      Serilog__Properties__ApplicationName: "Store"
    ports:
      - "7171:8080"
    depends_on:
      - database
      - seq
      - minio
    networks:
      - database-api-bridge
      - minio-api-bridge

networks:
  minio-api-bridge:
    driver: bridge
  database-api-bridge:
    driver: bridge
  database-sso-bridge:
    driver: bridge
  opensearch-net:

volumes:
  database_data:
  seq_data:
  minio_data:
  keycloak_data:
  sso_data:
  opensearch-data1:
  opensearch-data2: